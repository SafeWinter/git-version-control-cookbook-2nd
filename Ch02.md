# 第二章 配置 Git

相关主题：

- 配置目标
- 检索已有配置
- 配置模板
- `.git` 目录模板
- 几个配置示例
- 设置 Git 别名
- `refspec` 举例



## 2.1 配置目标

Git 配置分三个层次：

- `SYSTEM` 级：系统级配置，文件路径：
  - Linux: `/etc/gitconfig`; 
  - Windows: `C:\Git\etc\gitconfig`
- `GLOBAL` 级：用户级配置，文件路径：`~/.gitconfig`
- `LOCAL` 级：仓库级配置，文件路径：`.git/config`

练习：

```bash
# Sync repo status
$ git clone https://git.eclipse.org/r/jgit/jgit demo
$ cd demo
# List the system config
$ git config --list --system
# List the global (user) config
$ git config --list --global
# List the repo config
$ git config --list --local

# Query single key
$ git config --global user.email
# Set a key locally
$ git config --local user.email john@example.com
# Set default git editor
$ git config --global core.editor vim
```



## 2.2 检索已有配置

```bash
# View all the effective configurations for the current Git repository
$ git config --list
# Show single configuration item
$ git config user.name
# Set a new username
$ git config user.name "John Doe"
# Set your own configuration
$ git config my.own.config "Whatever I need"
$ git config my.his.config "Whatever He need"
$ git config my.own.config.item item
# Check the config file
$ cat .git/config
# ... sth irrelevant
[my "own"]
        config = Whatever I need
[my "his"]
        config = Whatever He need
[my "own.config"]
        item = item
# Show the value assigned
$ git config my.own.config
Whatever I need
$ git config my.own.config.item
item
```



## 2.3 配置模板

模板通常在用户级配置，一般不在仓库级配置。

```powershell
# Demonstrated in Windows
> git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition.git demo
> git demo
# Create template file, save as ~/gitcommitmsg.txt
> notepad
# Demo content:
# Short description of commit 
# 
# Longer explanation of the motivation for the change 
# 
# Fixes-Bug: Enter bug-id or delete line 
# Implements-Requirement: Enter requirement-id or delete line 

# Config commit template
> git config --global commit.template ~/gitcommitmsg.txt
# Create a new commit
> echo "test new content" >> abc.txt
> git status -s
?? abc.txt
> git add abc.txt; git status
A  abc.txt
> git commit
# This would display a Sublime Text 3 interface:
```

![git template](assets/c2-1.png)

```powershell
# Edit the template content, save and exit sublime text
> git commit
[master a5c36d0] Test git template file
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 abc.txt
> git log -1
commit a5c36d0bb6bcd5e3599de500e7628c296554aa93 (HEAD -> master)
Author: SafeWinter <zandong_19@aliyun.com>
Date:   Sat Nov 27 23:30:16 2021 +0800

    Test git template file

    Added a new file called abc.txt to test the functionality of git template

    Fixes-Bug: demo-bug-001
    Implements-Requirement: (skip)
```



### 相关注意事项

1. 配置 `Sublime Text 3` 为默认编辑器时，需加 `-w` 参数，表示 `wait`，即等待提交内容保存完毕后才可退出编辑，否则会默认提交失败。相关的 Git 配置如下（`Windows` 环境下，路径分隔符 **只能是** `\\`）：

```bash
# List git default editor (Sublime Text 3)
$ git config --system core.editor
'C:\\ProgramFiles\\SublimeText3\\subl.exe' -w
# Config Sublime Text 3 as default git editor
$ git config --system core.editor "'C:\\ProgramFiles\\SublimeText3\\subl.exe' -w"
```



2. `Window` 下的 Git 设置不可直接用于 `WSL2`，因为绝对路径在 `Linux` 环境下不存在 `C:\`，而是挂载在 `/mnt/` 路径下。



3. 虽然对 WSL2 可重新配置默认编辑器：

   ```bash
   $ git config --system core.editor
   '/mnt/c/ProgramFiles/SublimeText3/subl.exe' -w
   ```

   当在 `WSL2` 但运行 `git commit` 时，`Sublime Text 3` 会默认保存到 `Win10` 环境下的 `.git` 文件夹内，临时文件名为： `.git/COMMIT_EDITMSG`；然而此时使用的路径还是 WSL2 的 `/mnt/c/...`，因此首次默认保存提交注释会出错，需要手动指定到当前 `.git` 文件夹内，再次覆盖保存。



4. 由于 `Linux` 和 `Windows` 的根路径不同，要尽量避免同时在 `Windows` 和 `Linux` 环境内提交新版本，否则将报错：

   ```bash
   # Under WSL2 environment
   $ git commit
   hint: Waiting for your editor to close the file... 'C:\\ProgramFiles\\SublimeText3\\subl.exe' -w: 1: C:\\ProgramFiles\\SublimeText3\\subl.exe: not found
   error: There was a problem with the editor ''C:\\ProgramFiles\\SublimeText3\\subl.exe' -w'.
   Please supply the message using either -m or -F option.
   ```

   

5. 模板注释文件也可以是仓库级别的，只要将文件配置在 `--local` 级别即可，以满足更多样化的模板设置。



## 2.4 `.git` 目录模板

除了全局配置，有时进行版本控制时还需要触发一些例行脚本的执行（这些 `script` 脚本即 `Git hooks`、Git 钩子），或者是模板化地剔除一些文件等。此时可以对 `git init` 命令设置模板化操作。

这些模板化的操作的运行方式：

1. 作为 `git clone`、`git init` 命令的参数项运行；
2. 作为 `$GIT_TEMPLATE_DIR` 环境变量运行；
3. 作为 Git 的配置项运行（配置 `init.templatedir` 实现，默认路径为 `/usr/share/git-core/templates` ）。



> **模板化操作的工作原理**
>
> 将指定模板文件夹内的文件复制到 `.git` （即 `$GIT_DIR` ）文件夹。

本节演示两个模板操作：

1. `git hook` 示例
2. 以模板的方式设置剔除清单，阻止所有 `*.txt` 文件进入版本控制



### 示例1：Git 钩子

```bash
# Make customed template directory
$ mkdir ~/.git_template
$ mkdir ~/.git_template/{hooks,info}
# Copy git default hook files
$ cd ~/.git_template/hooks
$ cp /usr/share/git-core/templates/hooks/* .
# Rename commit-msg.sample file
$ cp commit-msg.sample commit-msg
# Edit with vim in commit-msg:
```

![content in new commit-msg hook](assets/c2-2.png)

```bash
# Make the hook executable
$ chmod +x ~/.git_template/hooks/commit-msg
# Config git template directory
$ git config --global init.templatedir ~/.git_template
# Testing and validating
$ cd ~ && git init template-example && cd template-example
$ echo "something to commit" > somefile
$ git add somefile
$ git commit -m "Committed something"
$ git log -1
```

![Testing & validating new config](assets/c2-3.png)



---

### 示例2：剔除 *.txt 文件

本例将所有 `*.txt` 文件手动剔除版本控制，相当于 `.gitignore` 文件的作用。

```bash
# Make a new exclude file into template folder
$ echo "*.txt" > ~/.git_template/info/exclude
# testing
$ cd ~ && git init template-example2 && cd template-example2
$ echo "this is the readme file" > README.txt
$ git status
```

![add DIY exclude file pattern](assets/c2-4.png)



> **小结**
>
> 1. 每当进行 `init` 或 `clone` 操作，创建文件夹时 git 会自动将模板文件夹内的文件复制到新版本库 `.git` 中。除了在配置文件中关联自定义的模板文件夹路径外，还可以在命令行或环境变量中进行指定；
>
> 2. 示例中使用了 `--global`，意味着对该用户的所有相关操作生效。但也有不足：对配置生效前同样需要应用相同模板规则的旧仓库，只能手动再执行一遍 `git init`；
>
> 3. 示例仅对 **Linux** 系统生效，**Windows** 系统的默认模板路径在 `{GIT_INSTALL_DIR}\mingw64\share\git-core\templates`，且 `\n` 在 **Windows** 系统不能输出一个回车，可以追加一个空串：
>
>    ```bash
>    #!/bin/sh
>    MSG_FILE="$1"
>    echo "" >> $MSG_FILE
>    echo "Hi from template commit-msg hook on Win10" >> $MSG_FILE
>    ```





## 2.5 几个配置示例





## 2.6 设置 Git 别名

## 2.7 `refspec` 举例

