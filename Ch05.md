# 第五章 在 `Git` 仓库存入附加信息

相关主题：

- 添加第一条 `Git` 笔记
- 按类别区分 `Git` 笔记
- 从远程库读取 `Git` 笔记
- 推送 Git 笔记到远程库
- 为 `commit` 版本添加标签

---



`Git` 最强大的一个特性，在于它的提交历史永不可改变。这意味着任何试图篡改仓库历史的行为，对其他克隆该仓库的人来说都是可见的。这一特性也给开发者带来些许困扰，尤其是需要在已经发布的提交记录中修改版本注释信息的时候。正是由于 `git` 历史的不可变更性，`git` 笔记（`notes`）才应运而生。本质上，`git` 笔记是 `refs/notes/commits` 引用的附加版。笔记内容既可以在执行 `git log` 命令时，随提交信息一同展示出来，也可以发布到远程仓库供其他人获取笔记。



## 5.1. 添加第一条 `Git` 笔记

本节将在已发布的版本中添加附加信息。如果直接修改目标版本，则 `commit` 的哈希值也会变动。以 `jgit` 库为例，先演示直接修改历史版本的效果，再给出使用 `git` 笔记的演示方案。

```bash
# Clone repo
$ git clone https://git.eclipse.org/r/jgit/jgit chapter5
$ cd chapter5 
# Checkout a new branch based on stable-3.2
$ git checkout -b notesMessage  --track origin/stable-3.2
# Check HEAD hash: f839d383e6fbbda26729db7fd57fc917fa47db44
$ git log -1 
# Edit commit message, add 'Update MANIFEST files'
$ git commit --amend
# Check HEAD hash: f942f7b58238b5aaac566038a7d67e0cb6a02fe1
# commit hash diverged
$ git log -1 
# See the change via status
$ git status
# via gitk
$ gitk origin/stable-3.2 HEAD
```

结果如下：（版本结构已发生变化）

![diverged commits](assets/c5-1.png)

这是使用 `git note` 就可避免：

```bash
# Resume
$ git reset --hard origin/stable-3.2
# Add a git note
$ git notes add -m 'Update MANIFEST files'
# Check git log (f839d383e6fbbda26729db7fd57fc917fa47db44)
$ git log -1
commit f839d383e6fbbda26729db7fd57fc917fa47db44 (HEAD -> notesMessage, origin/stable-3.2)
Author: Matthias Sohn <matthias.sohn@sap.com>
Date:   Wed Dec 18 21:16:13 2013 +0100

    Prepare post 3.2.0 builds

    Change-Id: Ie2bfdee0c492e3d61d92acb04c5bef641f5f132f
    Signed-off-by: Matthias Sohn <matthias.sohn@sap.com>

Notes:
    Update MANIFEST files
# Check status (not diverged)
$ git status
# (No changes)
```

虽然 `git notes` 没有在原记录上直接修改（像 `--amend` 那样），但也实现了对历史提交信息进行增补，且不影响原有的树形版本结构。



> **拓展**

除了通过 `git notes add` 新增一个 `git` 笔记，还可以强制替换（`-f`）、追加（`append`）、编辑（`edit`）`git` 笔记：

```bash
# force to add notes (replace the old one)
$ git notes add -f -m "Update MANIFESTS files for next version"
# append content to a note
$ git notes append -m "Verified by John Doe"
# Show in the log via --notes
$ git log --oneline --notes
f839d383e (HEAD -> notesMessage, origin/stable-3.2) Prepare post 3.2.0 builds
Notes:
    Update MANIFESTS files for next version

    erified by John Doe

# Edit a note (this would replace the old note with 'John Doe')
$ git notes edit -m 'John Doe'
The -m/-F/-c/-C options have been deprecated for the 'edit' subcommand.
Please use 'git notes add -f -m/-F/-c/-C' instead.
# git notes edit without any arguments would be the same as git notes add
$ git log --oneline --notes -1
f839d383e (HEAD -> notesMessage, origin/stable-3.2) Prepare post 3.2.0 builds
Notes:
    John Doe

```

更多子命令，详见 `git help notes`。



> **小结**

1. `git notes edit -m` 的用法已被淘汰，Git 推荐使用 `git notes add` 来替换 `git notes edit`；
2. 决定 commit 哈希值的三个因素：
   1. 版本内容（the content in the commit）
   2. 父级版本（the parents of the commit）
   3. 提交信息（the commit message）

---





## 5.2 按类别区分 `Git` 笔记







## 5.3 从远程库读取 `Git` 笔记

## 5.4 推送 Git 笔记到远程库

## 5.5 为 `commit` 版本添加标签
