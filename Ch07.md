# 第七章 用 Git 钩子、别名、脚本提升日常工作效率

相关主题：

- 在提交消息中应用分支描述信息
- 创建提交消息的动态模板
- 在提交消息中应用外部信息
- 阻止特定版本推送到远程库
- 配置并使用 Git 别名
- 配置并使用 Git 脚本
- 设置并使用提交消息模板

---



为了在公司高效工作，产出的任何代码都该遵循一些原则或规范，让其顺利通过编译或单元测试；也应该在提交注释中加上一定的文字说明，比如已修复的 `bug` 的 ID 标识，或者相关实例的引用等等。绝大部分这类规则都可以通过脚本自动完成。既然如此，何不让它们在版本提交时自动进行呢？本章给出的示例，将向您展示如何在输出最终的提交注释前，将某处的数据转移到提交注释中，并可以学到一些实用方法，验证代码是否推送到想要的地方。最后介绍如何在 Git 中添加执行脚本。

Git 中的钩子（`hook`）是一段处理脚本，可以在特定事件发生时触发执行（如推送、提交、变基等）。如果脚本在退出时返回一个非零的值，则取消当前的 `git` 操作。这些 `hook` 脚本可以在克隆到本地的仓库文件夹 `.git/hooks` 下找到。如果文件扩展名是 `.sample`，表示当前不生效。





## 7.1 在提交消息中应用分支描述信息

在第三章介绍分支时，提到过为分支设置描述信息的命令，查看描述内容可通过如下命令完成：

```bash
$ git config --get branch.<branchname> description
```

本节示例演示怎样将分支描述信息应用到提交注释中。需要用到的 `hook` 钩子，叫作 `prepare-commit-msg`，在提交时触发。在实际弹出提交注释的编辑器之前，可以将钩子设置为您想要检查的任何内容。

示例中的脚本编写需要一定的 `shell` 基础。

以 `jgit` 库的 `stable-3.2` 分支为例，演示怎样在本地分支设置描述信息、进而创建 git 钩子了提取该信息到提交注释中：

```bash
# prepare repo and branch
$ git clone https://git.eclipse.org/r/jgit/jgit chapter7.5
$ cd chapter7.5
$ git checkout -b descriptioInCommit  --track origin/stable-3.2
# Edit description
$ git branch --edit-description descriptioInCommit
########### branch description start ###########
Remote agent not connection to server
    
When the remote agent is trying to connect
it will fail as network services are not up
and running when remote agent tries the first time
########### branch description stop  ###########
# Check the config
$ git config --get branch.descriptioInCommit.description
# edit hook file and make it executable (chmod +x)
$ vim .git/hook/prepare-commit-msg
# hook content:
#!/bin/bash
BRANCH=$(git branch | grep '*'| sed 's/*//g'|  sed 's/ //g')
DESCRIPTION=$(git config --get branch.${BRANCH}.description)
if [ -z "$DESCRIPTION" ]; then
  echo "No desc for branch using default template"
else
  # replacing # with n
  DESCRIPTION=$(echo "$DESCRIPTION" | sed 's/#/\n/g')
  # replacing the first \n with \n\n
  DESCRIPTION=$(echo "$DESCRIPTION" | sed 's/\n/\n\n/')
# append default commit message
DESCRIPTION=$(echo "$DESCRIPTION" && cat $1)
# and write it all to the commit message
echo "$DESCRIPTION" > $1
fi
# Test with an empty commit
$ git commit --allow-empty
```

弹出的编辑器窗口情况如下：

![test branch description](assets/c7-1.png)

```bash
# save and check it in git log:
$ git log -1
commit a2aad6607b1d251a480bbf98b3e8ab4063266165 (HEAD -> descriptionInCommit)
Author: SafeWinter <zandong_19@aliyun.com>
Date:   Sat Dec 18 19:35:08 2021 +0800

    Remote agent not connection to server

    When the remote agent is trying to connect
    it will fail as network services are not up
    and running when remote agent tries the first time
# Checkout another new branch and test
$ git checkout -b noDescriptionBranch
$ git commit --allow-empty
```

结果如下：

![test with no branch description](assets/c7-2.png)





## 7.2 创建提交消息的动态模板

## 7.3 在提交消息中应用外部信息

## 7.4 阻止特定版本推送到远程库

## 7.5 配置并使用 Git 别名

## 7.6 配置并使用 Git 脚本

## 7.7 设置并使用提交消息模板
