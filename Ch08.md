# 第八章 从错误版本中恢复

相关主题：

- 撤销 – 完全移除一次 `commit`
- 撤销 – 删除提交版本但保留文件变更
- 撤销 – 删除提交版本但保留暂存区内的文件变更
- 撤销 – 与脏工作区打交道
- 重做 – 将新变更重新创建到最后一个 commit 版本
- 恢复 – 撤销由于提交引入的变更
- 对合并版本的恢复
- 用 `git reflog` 查看 Git 的历史动作
- 用 `git fsck` 找出遗失的变更

---

## 引言

如果直到推送或发布一次更新的时候才发现一个错误，`git` 可以在推送环境进行更正；如果已经推送到远程库，`git` 也可以撤回到错误引入时的那个版本。

本章将考察 `git reflog` 命令的使用，以及运用 `git fsck` 还原丢失的信息。

其实 `Git` 的核心库并未提供现成的撤回（`undo`）命令，因为“撤回”是一个很模糊的概念：究竟是撤回到上一个版本，还是到新增的文件？如果是撤回上一个版本，对应的具体操作是什么？是把当次提交的变更删掉吗？是退回到上一次提交后的状态，还是说仅仅撤回上一个版本，略作修改以便再次提交？还或者，只是更新一下提交注释的内容？……有太多不确定的因素需要明确。

本章将根据演示需要，探讨撤回操作可能涉及的几种情况：

- 完全撤回：删除所有变更，还原回上一次提交后的状态；
- 撤销提交，并从暂存区退出：即撤回到加入暂存区前的状态；
- 仅撤回提交：暂存区（或索引区）不动，允许细小变更以便重新提交；
- 从脏工作区撤回提交。



注意：实际工作中，由于会变更历史版本，类似撤回已推送的版本，通常是严格禁止的，本章只做演示。

## 8.1 完全移除一次 `commit`

本节演示第一种最简单的情况——完全撤回：

```bash
$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_hello_world_cookbook.git 
$ cd Git-Version-Control-Cookbook-Second-Edition_hello_world_cookbook.git
$ git status 
$ ls 
$ git log --oneline 
$ git reset --hard HEAD^
$ git log --oneline 
$ git status
$ ls
```

`git reset --hard HEAD^` 原理示意图：

![reset hard](assets/c8-1.png)










## 8.2 撤销 – 删除提交版本但保留文件变更

## 8.3 撤销 – 删除提交版本但保留暂存区内的文件变更

## 8.4 撤销 – 与脏工作区打交道

## 8.5 重做 – 将新变更重新创建到最后一个 `commit` 版本

## 8.6 恢复 – 撤销由于提交引入的变更

## 8.7 对合并版本的恢复

## 8.8 用 `git reflog` 查看 `Git` 的历史动作

## 8.9 用 `git fsck` 找出遗失的变更

